/*
* spinControl
* 
*     touch spin input control for mobile WebKit
*     (also works on desktop webkit browsers for testing/dev purposes) 
*
* Copyright (c) 2010 
* http://42at.com/lab/spinControl
* Released under MIT license
* 
* Version 0.1 - Last updated: 2010.02.5
*/
(function(g){g.spinControl=f;g.spinToggle=b;function f(p,m,k){var j=this;var n=k||{};var h=arguments.length;this.valuesFnc=null;this._position=0;if(m instanceof Array){this.values=m}else{if(h>4){n=arguments[4];this.values=e(arguments[1],arguments[2],arguments[3])}else{if(h==4){n=typeof arguments[3]=="object"?arguments[3]:null;this.values=e(arguments[1],arguments[2],n?1:arguments[3])}else{if(h==3){n=typeof arguments[2]=="object"?arguments[2]:null;if(n){if(typeof arguments[1]!="function"){this.values=e(1,arguments[1],1)}else{this.valuesFnc=arguments[1];this.values=e(0,100,1)}}else{this.values=e(arguments[1],arguments[2],1)}}else{if(h==2){n=typeof arguments[1]=="object"?arguments[1]:null;if(n||typeof arguments[1]=="function"){this.values=e(0,100,1)}else{if(typeof arguments[1]!="function"){this.values=e(1,arguments[1],1)}else{this.valuesFnc=arguments[1]}}}else{this.values=e(0,100,1)}}}}}this.options=c(c({},f.options.defaults),n);if(this.options.hints&&typeof this.options.hints=="string"){this.options.hints=this.options.hints.split("|")}this.wrapper=document.querySelector(p);this.thumb=this.options.thumbSelector?this.wrapper.querySelector(this.options.thumbSelector):null;this.$value=this.options.valueSelector?document.querySelector(this.options.valueSelector):null;this.labelsDiv=null;this.valueIndex=0;this.startIndex=-1;this.moving=false;this.value=this.values?this.values[this.valueIndex]:null;this.percent=0;if(!this.thumb){var i=document.createElement("div");i.className=this.options.thumbClass;this.thumb=this.wrapper.appendChild(i)}this.wrapper.className+=" "+this.options.spinClass;for(var o in this.options.spinCss){this.wrapper.style[o]=this.options.spinCss[o]}for(var o in this.options.thumbCss){this.thumb.style[o]=this.options.thumbCss[o]}this.thumb.webkitTransitionProperty="-webkit-transform";this.thumb.style.webkitTransitionTimingFunction=this.options.easing;this.thumb.style.webkitTransform="translate3d(0, 0, 0)";this.thumb.addEventListener(window.Touch?"touchstart":"mousedown",this,true);this.numberOfTouches=1;d(this);if(this.options.spinToClick||this.options.enableToggle){this.wrapper.addEventListener("click",this,true)}if(typeof window.orientation!="undefined"){document.body.addEventListener("orientationchange",this,true)}this.refresh();if(typeof this.options.initialValue!="undefined"){if(this.options.initialValue!==null){this.valueIndex=-1;this.setValue(this.options.initialValue)}}else{this.setIndex(0)}if(this.options.disabled){this.disable()}}f.options={defaults:{easing:"ease-out",easingDuration:350,labels:true,spinToClick:true,enableSnap:true,enableToggle:false,hints:null,disabled:false,bounciness:0.2,acceleration:1,alignToEdge:false,valueSelector:".spinValue",spinClass:"spin",thumbClass:"spinThumb",labelClass:"spinLabel",selectedClass:"selected",labelsDivClass:"spinLabelsDiv",disabledClass:"spinDisabled",spinCss:{},thumbCss:{},labelWidthAdjust:1,onspinbegin:null,onspin:null,onspinend:null,onchange:null,onclick:null,dummy:null}};f.prototype={spin:function(h){if(typeof this.options.onspin=="function"){return this.options.onspin.apply(this,arguments)}},change:function(){if(typeof this.options.onchange=="function"){return this.options.onchange.apply(this,arguments)}if(this.$value){this.$value.innerHTML=this.options.hints?this.options.hints[this.valueIndex]:this.value}},spinend:function(){if(typeof this.options.onspinend=="function"){return this.options.onspinend.apply(this,arguments)}},spinbegin:function(){if(typeof this.options.onspinbegin=="function"){return this.options.onspinbegin.apply(this,arguments)}},click:function(){if(typeof this.options.onclick=="function"){return this.options.onclick.apply(this,arguments)}return true},getValue:function(){return this.value},getIndex:function(){return this.valueIndex},setValue:function(i){if(typeof i!="undefined"&&this.values){for(var h in this.values){if(i==this.values[h]){this.setIndex(h);break}}}return this.value},setIndex:function(j){if(typeof j!="undefined"&&this.values&&j>=0&&j<this.values.length){var l=this.positionAtIndex(j),k=this.adjustDuration(j);if(j!=this.valueIndex){var h=this.position();this.updateValue(j>>0);this.triggerCallback("spin",l-h,true);this.change()}this.spinTo(l,k)}return this.valueIndex},toggle:function(){var h=this.valueIndex;if(h<this.values.length-1){h++}else{h=0}this.setIndex(h);return this.value},next:function(k){k=typeof k=="undefined"?1:k;var j=this.valueIndex,h=this.values.length-1;if(j+k>h||j+k<0){return null}this.setIndex(j+k);return this.value},prev:function(h){h=typeof h=="undefined"?1:h;return this.next(-h)},first:function(){this.setIndex(0);return this.value},last:function(){this.setIndex(this.values.length-1);return this.value},disable:function(){this.disabled=true;this.wrapper.className+=" "+this.options.disabledClass},enable:function(){this.disabled=false;this.wrapper.className=this.wrapper.className.replace(new RegExp("\\b"+this.options.disabledClass+"\\b","g"),"")},destroy:function(){this.destroyLabels();if(this.thumb){this.thumb.removeEventListener(window.Touch?"touchstart":"mousedown",this,true);this.wrapper.removeChild(this.thumb);this.thumb=null}if(this.options.spinToClick||this.options.enableToggle){this.wrapper.removeEventListener("click",this,true)}if(typeof window.orientation!="undefined"){document.body.removeEventListener("orientationchange",this,true)}for(var h in this.options.spinCss){this.wrapper.style[h]=""}this.wrapper=null;this.$value=null},positionAtIndex:function(l){if(!this.values){return 0}var k=0,h=0,n=0,o,m;if(this.options.alignToEdge&&(this.moving||this.options.type=="spinToggle")){o=1;h=0}else{o=0.5;h=Math.floor(this.wrapper.offsetWidth/2)}while(k<=l){m=this.labelsDiv.children[k++];n=m.offsetWidth+parseInt(getComputedStyle(m).getPropertyValue("margin-left"))+parseInt(getComputedStyle(m).getPropertyValue("margin-right"));h-=n}h=Math.floor(h+o*n);if(this.options.alignToEdge&&!this.moving){h=this.alignPosition(h)}return h},indexFromNode:function(j){var h=-1;while(j){j=j.previousSibling;h++}return h},alignPosition:function(h){var l=-this.labelsDivWidth+this.wrapper.offsetWidth-(this.options.type=="spinToggle"?0:2);if(h<l){return l}var q=h,m=0,r=0,t,j,s;t=0.5;s=this.labelsDiv.firstChild.offsetWidth;var n=this.labelsDiv.children,o=n.length;while(q<-0.5*s&&m<o){var k=n[m++];s=k.offsetWidth+parseInt(getComputedStyle(k).getPropertyValue("margin-left"))+parseInt(getComputedStyle(k).getPropertyValue("margin-right"));q+=s;r-=s}return r},indexFromPos:function(m){if(!this.values){return 0}var h=m,j=0,n,l,k;if(this.options.alignToEdge){n=0.5;k=-this.labelsDiv.firstChild.offsetWidth}else{n=1;k=0.5*this.wrapper.clientWidth}while(h<n*k&&j<this.values.length){if(this.options.alignToEdge){k=this.labelsDiv.children[j].offsetWidth}h+=this.labelsDiv.children[j++].offsetWidth}return Math.max(0,--j)},triggerCallback:function(j){var i=this,h=[].slice.call(arguments);h.shift();setTimeout(function(){i[j].apply(i,h)},0)},handleEvent:function(h){if(this.disabled){return}switch(h.type){case"touchstart":case"mousedown":this.onTouchStart(h);break;case"touchmove":case"mousemove":this.onTouchMove(h);break;case"touchend":case"mouseup":this.onTouchEnd(h);break;case"click":if(!this.moving&&this.click(h)!==false){this.moving=false;this.onClick(h)}this.moving=false;break;case"orientationchange":this.onOrientation(h);break;case"webkitTransitionEnd":this.onTransitionEnd(h);break}},position:function(h){if(typeof h!="undefined"){this._position=h;this.thumb.style.webkitTransform="translate3d("+h+"px, 0, 0)"}return this._position},refresh:function(){this.thumb.style.webkitTransitionDuration="0";this.wrapperWidth=this.wrapper.clientWidth;this.labelsDivWidth=a(this);var h=this.labelsDivWidth;if(this.options.alignToEdge){this.maxSlide=-h+this.wrapperWidth;this.minSlide=0}else{this.maxSlide=-Math.floor(h-0.5*(this.wrapper.offsetWidth+this.labelsDiv.lastChild.offsetWidth));this.minSlide=Math.floor(0.5*(this.wrapper.offsetWidth-this.labelsDiv.firstChild.offsetWidth))}},onClick:function(k){var j=k.target;if(k.target.parentNode!=this.labelsDiv){return}var h=this.indexFromNode(j);if(this.options.spinToClick&&h!=this.valueIndex){this.startIndex=this.valueIndex;this.setIndex(h)}else{if(this.options.enableToggle){this.toggle()}}},destroyLabels:function(){if(!this.labelsDiv){return}var h=this.labelsDiv;while(h.firstChild){h.removeChild(h.firstChild)}h.parentNode.removeChild(h)},onOrientation:function(h){this.refresh();if(this.wrapperWidth!=this.wrapper.clientWidth){this.setIndex(this.valueIndex)}},onTouchStart:function(h){if(window.Touch&&h.targetTouches.length!=this.numberOfTouches){return}this.moving=false;if(this.values){this.startIndex=this.valueIndex}this.startX=window.Touch?h.targetTouches[0].clientX:h.clientX;this.startY=window.Touch?h.targetTouches[0].clientY:h.clientY;this.startTime=h.timeStamp;this.thumb.addEventListener(window.Touch?"touchmove":"mousemove",this,false);this.thumb.addEventListener(window.Touch?"touchend":"mouseup",this,false);this.triggerCallback("spinbegin")},onTouchMove:function(k){if(window.Touch&&k.targetTouches.length!=this.numberOfTouches){return}var o=window.Touch?k.targetTouches[0].clientX:k.clientX;var m=window.Touch?k.targetTouches[0].clientY:k.clientY;var j=window.getComputedStyle(this.thumb).webkitTransform;j=new WebKitCSSMatrix(j).m41;var i=o-this.startX;var h=m-this.startY;if(1.5*Math.abs(h)>Math.abs(i)||i==0){return true}k.preventDefault();var p=i;this.scrollTime=k.timeStamp-this.startTime;this.startTime=k.timeStamp;if((p>0&&j>=this.minSlide)||(p<0&&j<=this.maxSlide)){p/=3;p=p<0?Math.ceil(p):Math.floor(p)}var n=this.position(),l=n+p;if(this.options.bounciness==0){l=Math.max(Math.min(l,this.minSlide),this.maxSlide);if(j==l){return}p=l-n}this.moving=true;this.position(l);this.startX=o;this.delta=p;this.triggerCallback("spin",p);return},updateValue:function(h){this.value=this.valuesFnc?this.valuesFnc(h):this.values[h];this.valueIndex=h},onTouchEnd:function(o){o.preventDefault();this.thumb.removeEventListener(window.Touch?"touchmove":"mousemove",this,false);this.thumb.removeEventListener(window.Touch?"touchend":"mouseup",this,false);if(!this.moving){return false}if(!this.options.enableSnap||this.options.easingDuration==0){this.triggerCallback("spinend")}var k,n;if(!this.options.enableSnap){k=this.indexFromPos(this._position);if(this.startIndex!=k){this.updateValue(k);this.triggerCallback("change");this.updateSelected()}return false}var l=this.delta/this.scrollTime,j=0.00005/(1+Math.abs(this.options.acceleration))*this.wrapper.clientWidth,h,q;j=Math.max(0.0001,j);h=(this.delta<0?-1:1)*Math.floor(l*l/j);q=this._position+h;k=this.indexFromPos(q);if(this.options.alignToEdge){n=this.alignPosition(q)}else{if(k==this.valueIndex&&Math.abs(l)>0.1){k+=(l>0?-1:1)}if(k<0){k=0}if(k>this.values.length-1){k=this.values.length-1}n=this.positionAtIndex(k)}var m=this.adjustDuration(k);this.updateValue(k);this.spinTo(n,m);if(this.valueIndex!=this.startIndex){this.triggerCallback("change")}},adjustDuration:function(k){var h=Math.abs(this.valueIndex-k);if(!this.values||h<=1){return this.options.easingDuration}var j=0.7*(1+h)/this.values.length;var l=Math.floor(this.options.easingDuration*(1+j));return l},onTransitionEnd:function(h){this.thumb.style.webkitTransitionDuration="0";this.thumb.removeEventListener("webkitTransitionEnd",this,false);this.updateSelected();this.triggerCallback("spinend")},spinTo:function(m,k){k=k||this.options.easingDuration;if(k==0){this.position(m);this.updateSelected();return}if(m==this._position){this.updateSelected();return}var h=3,l=Math.floor(this.options.bounciness*(m-this._position)),i;if(this.valueIndex>0&&this.valueIndex<this.values.length-1){l=0}if(Math.abs(l)<h){l=0}i=l?Math.floor(0.7*k):k;this.thumb.style.webkitTransitionTimingFunction=this.options.easing;this.thumb.style.webkitTransitionDuration=i+"ms";if(l){var j=this;setTimeout(function(){j.thumb.style.webkitTransitionDuration=Math.floor(0.3*k)+"ms";j.thumb.addEventListener("webkitTransitionEnd",j,false);j.position(j._position-l)},i+20)}else{this.thumb.addEventListener("webkitTransitionEnd",this,false)}this.position(m+l);return},updateSelected:function(i){i=i||"";if(this.startIndex!=this.valueIndex&&this.options.selectedClass&&this.labelsDiv){if(i=="off"||i==""){var h=this.labelsDiv.querySelector("."+this.options.selectedClass);if(h){h.className=h.className.replace(new RegExp("\\b"+this.options.selectedClass+"\\b","g"),"")}}if(i=="on"||i==""){if(this.labelsDiv.childNodes.length>this.valueIndex){this.labelsDiv.childNodes[this.valueIndex].className+=" "+this.options.selectedClass}}}}};f.range=e;function e(p,i,m){var h=arguments.length;if(h==0){return[]}if(h==1){return arguments.callee(0,p,1)}if(h==2){return arguments.callee(p,i,1)}var j=[];if(m==0){return[]}if((p<=i&&m<0)||(p>=i&&m>0)){m=-m}var o=-1;var k=m.toString().indexOf(".");if(k!=-1){o=m.toString().length-(1+k);k=true}else{p>>=0;i>>=0;m>>=0;k=false}for(;m>0?p<=i:p>=i;p+=m){j.push(k?parseFloat(p.toFixed(o)):p)}return j}function d(r){var m=r.options.labels;switch(typeof m){case"boolean":case"number":m=r.values;break;case"string":m=m.split(/\|/);if(m.length!=r.values.length){m=new Array(r.values.length+1).join(m+"\u0000").split("\u0000",r.values.length)}break}var h=document.createElement("div");h.className=r.options.labelsDivClass;r.labelsDiv=r.thumb.appendChild(h);var o="",k=r.values.length>1?r.values.length:m.length,q=Math.floor(r.wrapper.clientWidth/r.values.length)-r.options.labelWidthAdjust;var i=false;if(r.options.labels==false||r.options.labels.length==0){i=" "}for(var l in r.values){var p=i||m[l];if(p===undefined){p=""}o+='<span class="'+r.options.labelClass+'">'+p+"</span>"}r.labelsDiv.innerHTML=o}function a(j){var h=0,l,k=j.labelsDiv.children.length;while(--k>=0){l=j.labelsDiv.children[k];h+=parseInt(l.offsetWidth)+parseInt(getComputedStyle(l).getPropertyValue("margin-left"))+parseInt(getComputedStyle(l).getPropertyValue("margin-left"))}return h}function c(h,j){for(var i in j){h[i]=j[i]}return h}function b(k,t,j){j=j||{};var o=j.labels||t;delete j.labels;if(t.length!=2){throw"spinToggle: values must be an array with only two values! id="+k+", values="+t}var u={type:"spinToggle",labels:o,selectedClass:"",enableToggle:true,bounciness:0,easingDuration:50,spinClass:"spinToggle",alignToEdge:true,spinToClick:j.enableToggle,_onchange:function(){}};if(j.onOffStyle){u.spinClass+=" onOffStyle"}for(var m in j){u[m]=j[m]}delete u.initialValue;var h=new f(k,t,u);h.base_click=h.click;h.click=function(i){this.toggle();this.base_click(i);return false};var p=document.createElement("span");p.className=h.options.labelClass+" thimbleClass";p.innerHTML="";p=h.labelsDiv.insertBefore(p,h.labelsDiv.lastChild);var n=h.labelsDiv.firstChild.offsetWidth-h.labelsDiv.lastChild.offsetWidth,k=n>0?h.labelsDiv.lastChild:h.labelsDiv.firstChild;n=Math.abs(n);if(n>0){var s=Math.floor(n/2),l=n-s;k.style.paddingLeft=s+parseInt(getComputedStyle(k).getPropertyValue("padding-left"))+"px";k.style.paddingRight=l+parseInt(getComputedStyle(k).getPropertyValue("padding-right"))+"px"}var r=parseInt(getComputedStyle(h.thumb).getPropertyValue("padding-left"))+parseInt(getComputedStyle(h.thumb).getPropertyValue("border-left-width"));var q=2*r+h.labelsDiv.firstChild.offsetWidth+p.offsetWidth;h.wrapper.style.width=q+"px";h.refresh();h.maxSlide=-h.labelsDiv.firstChild.offsetWidth;h.labelsDivWidth+=2*r;h.onOrientation=function(){};if("initialValue" in j){h.setValue(j.initialValue)}else{h.setIndex(0)}return h}})(this);